#!/usr/bin/env perl

my $srcdir     = $ARGV[0];
my $functional = $ARGV[1];
my $order      = $ARGV[2];

my $mathfile = "$srcdir/mathematica/functionals/$functional.m";

# Find out the type of functional
open my $in, '<', $mathfile or 
    die "File $srcdir/mathematica/functionals/$functional.m does not exist\n";
my $line = <$in>;
close($in);

$line =~ /type:\s(\S*)\s/;
my $functype = $1;

open my $out, '>', "$srcdir/autogen/$functional.c" or 
    die "Could not open file $srcdir/autogen/$functional.c for writing\n";

print $out "/* 
  This file was generated automatically with $0.
  Do not edit this file directly as it can be overwritten!!

  Mathematica source: $mathfile
  Type of functional: $functype
*/

#include <stdio.h>
#include <stdlib.h>
#include <assert.h>
#include <util.h>
";

if($functype ne "work_gga_x"){
  die "Only work_gga_x is implemented at the moment\n";
}

# first we print the value of the energy
if($order >= 0){
  print $out "
/* energy functional */
FLOAT
auto_$functional_e(FLOAT x)
{

  return ";

  print "math -script $srcdir/mathematica/work_gga_x.m $mathfile 0\n";
  $math = `math -script $srcdir/mathematica/work_gga_x.m $mathfile 0`;
  print $out "$math;

}
";
}

close($out);
